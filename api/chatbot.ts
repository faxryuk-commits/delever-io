// –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ–º –∏–∑ –°–®–ê (–¥–ª—è OpenAI)
export const config = {
  runtime: 'edge',
  regions: ['iad1'], // Washington DC, USA
}

// –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π Delever (–∏–∑ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å–∞–π—Ç–∞)
const KNOWLEDGE_BASE = `
# –û –∫–æ–º–ø–∞–Ω–∏–∏ Delever

Delever ‚Äî –µ–¥–∏–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç–∞–≤–∫–æ–π. –û—Å–Ω–æ–≤–∞–Ω–∞ –≤ 2020 –≥–æ–¥—É –≤ –¢–∞—à–∫–µ–Ω—Ç–µ, –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω.

## –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:
- 1000+ –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã—Ö –±–∏–∑–Ω–µ—Å–æ–≤
- 7 —Å—Ç—Ä–∞–Ω –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è (–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω, –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω, –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω, –ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω, –ì—Ä—É–∑–∏—è, –ö–∏–ø—Ä, –û–ê–≠)
- 13+ –º–∏–ª–ª–∏–æ–Ω–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
- 40+ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
- 99.9% uptime

## –ö–ª–∏–µ–Ω—Ç—ã:
Yaponamama, EVOS, Maxway, Les Ailes, Brasserie, Pizza Hut, Hardee's, GIPPO –∏ –¥—Ä—É–≥–∏–µ.

# –ü—Ä–æ–¥—É–∫—Ç—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏

## –ö–∞–Ω–∞–ª—ã –ø—Ä–æ–¥–∞–∂:
- –ë—Ä–µ–Ω–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∞–π—Ç –¥–ª—è –∑–∞–∫–∞–∑–æ–≤ (–±–µ–∑ –∫–æ–º–∏—Å—Å–∏–π)
- –ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ iOS/Android (White Label)
- Telegram-–±–æ—Ç –¥–ª—è –ø—Ä–∏—ë–º–∞ –∑–∞–∫–∞–∑–æ–≤
- QR-–º–µ–Ω—é –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–æ–ª–ª-—Ü–µ–Ω—Ç—Ä–æ–º

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä–∞–º–∏:
–í—Å–µ –∑–∞–∫–∞–∑—ã –∏–∑ –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä–æ–≤ –≤ –æ–¥–Ω–æ–º –æ–∫–Ω–µ:
- Wolt
- Glovo  
- Yandex Eats
- Uzum Tezkor
- Chocofood
- Foody

–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- –ï–¥–∏–Ω—ã–π —ç–∫—Ä–∞–Ω –¥–ª—è –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤
- –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –∫–∞—Å—Å–æ–π (iiko, R-Keeper, Poster)
- –ï–¥–∏–Ω–æ–µ –º–µ–Ω—é –Ω–∞ –≤—Å–µ –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä—ã
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–æ–ø-–ª–∏—Å—Ç–∞–º–∏
- –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

## –û–ø–µ—Ä–∞—Ü–∏–∏ –∏ –ª–æ–≥–∏—Å—Ç–∏–∫–∞:
- –î–∏—Å–ø–µ—Ç—á–µ—Ä–∏–∑–∞—Ü–∏—è –∑–∞–∫–∞–∑–æ–≤
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ä—å–µ—Ä–∞–º–∏ —Å GPS-—Ç—Ä–µ–∫–∏–Ω–≥–æ–º
- –ê–≤—Ç–æ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ –∫—É—Ä—å–µ—Ä–∞–º
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–≤
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∫—É—Ä—å–µ—Ä–æ–≤

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å POS-—Å–∏—Å—Ç–µ–º–∞–º–∏:
- iiko
- R-Keeper
- Jowi
- Poster
- Paloma
- Syrve
- Yaros
- Clopos

## –ê–Ω–∞–ª–∏—Ç–∏–∫–∞:
- –î–∞—à–±–æ—Ä–¥—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- ABC/XYZ –∞–Ω–∞–ª–∏–∑ –º–µ–Ω—é
- –û—Ç—á—ë—Ç—ã –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫—É—Ä—å–µ—Ä–æ–≤
- AI-–ø—Ä–æ–≥–Ω–æ–∑—ã —Å–ø—Ä–æ—Å–∞

## CRM –∏ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥:
- RFM-—Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤
- Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ SMS-—Ä–∞—Å—Å—ã–ª–∫–∏
- –ü—Ä–æ–≥—Ä–∞–º–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ (–±–æ–Ω—É—Å—ã, –∫—ç—à–±—ç–∫)
- –ü—Ä–æ–º–æ–∫–æ–¥—ã –∏ –∞–∫—Ü–∏–∏
- –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ –∫–ª–∏–µ–Ω—Ç–æ–≤

# –¢–∞—Ä–∏—Ñ—ã

## Start ‚Äî –æ—Ç 1,300,000 —Å—É–º/–º–µ—Å (~$99)
- –î–æ 1000 –∑–∞–∫–∞–∑–æ–≤/–º–µ—Å
- 1 —Ñ–∏–ª–∏–∞–ª
- –ë–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

## Medium ‚Äî –æ—Ç 2,400,000 —Å—É–º/–º–µ—Å (~$185)  
- –î–æ 3000 –∑–∞–∫–∞–∑–æ–≤/–º–µ—Å
- –î–æ 3 —Ñ–∏–ª–∏–∞–ª–æ–≤
- –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

## Big ‚Äî –æ—Ç 4,300,000 —Å—É–º/–º–µ—Å (~$330)
- –î–æ 6000 –∑–∞–∫–∞–∑–æ–≤/–º–µ—Å
- –î–æ 7 —Ñ–∏–ª–∏–∞–ª–æ–≤
- CRM –∏ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥

## Enterprise ‚Äî –æ—Ç 6,500,000 —Å—É–º/–º–µ—Å (~$500)
- 10,000+ –∑–∞–∫–∞–∑–æ–≤/–º–µ—Å
- –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ —Ñ–∏–ª–∏–∞–ª–æ–≤
- –í—ã–¥–µ–ª–µ–Ω–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä
- SLA 99.9%

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:
- White Label –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: –æ—Ç $2,000 –µ–¥–∏–Ω–æ—Ä–∞–∑–æ–≤–æ
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä–∞–º–∏: –æ—Ç $50/–º–µ—Å –∑–∞ –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä
- –ö–∏–æ—Å–∫ —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è: –æ—Ç $30/–º–µ—Å –∑–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ

# –ó–∞–ø—É—Å–∫ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞

- –ó–∞–ø—É—Å–∫ –∑–∞ 1 –¥–µ–Ω—å
- –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –º–µ–Ω—é
- –û–±—É—á–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞
- –¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞ 24/7 –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä

# –ö–æ–Ω—Ç–∞–∫—Ç—ã

- –¢–µ–ª–µ—Ñ–æ–Ω: +998 78 113 98 13
- Email: support@delever.uz
- Telegram: @deleverme
- –û—Ñ–∏—Å: –¢–∞—à–∫–µ–Ω—Ç, –ø—Ä–æ—Å–ø–µ–∫—Ç –ê–º–∏—Ä–∞ –¢–µ–º—É—Ä–∞ 129–ë

# –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–ª–∏–µ–Ω—Ç–æ–≤

- –°–Ω–∏–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –Ω–∞ 35%
- –†–æ—Å—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ —á–µ–∫–∞ –Ω–∞ 25%
- –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ 40%
- –≠–∫–æ–Ω–æ–º–∏—è –Ω–∞ –∫–æ–º–∏—Å—Å–∏—è—Ö –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä–æ–≤ –¥–æ 15 –º–ª–Ω —Å—É–º/–º–µ—Å
`

// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è —Ç–∏–ø–∏–∑–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ AI)
type UserIntent = 'info' | 'pricing' | 'demo' | 'support' | 'hot_lead' | 'unknown'
void ('' as UserIntent) // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ SYSTEM_PROMPT

// Offline –æ—Ç–≤–µ—Ç—ã –∫–æ–≥–¥–∞ OpenAI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
function getOfflineResponse(message: string): string {
  const lowerMessage = message.toLowerCase()
  
  if (lowerMessage.includes('—Ç–∞—Ä–∏—Ñ') || lowerMessage.includes('—Ü–µ–Ω') || lowerMessage.includes('—Å—Ç–æ–∏')) {
    return `üí∞ –¢–∞—Ä–∏—Ñ—ã Delever:

‚Ä¢ Start ‚Äî –æ—Ç 1.3 –º–ª–Ω —Å—É–º/–º–µ—Å (–¥–æ 1000 –∑–∞–∫–∞–∑–æ–≤)
‚Ä¢ Medium ‚Äî –æ—Ç 2.4 –º–ª–Ω —Å—É–º/–º–µ—Å (–¥–æ 3000 –∑–∞–∫–∞–∑–æ–≤)
‚Ä¢ Big ‚Äî –æ—Ç 4.3 –º–ª–Ω —Å—É–º/–º–µ—Å (–¥–æ 6000 –∑–∞–∫–∞–∑–æ–≤)
‚Ä¢ Enterprise ‚Äî –æ—Ç 6.5 –º–ª–Ω —Å—É–º/–º–µ—Å (10,000+ –∑–∞–∫–∞–∑–æ–≤)

–•–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å —Ç–æ—á–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å? –°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏: +998 78 113 98 13`
  }
  
  if (lowerMessage.includes('–∏–Ω—Ç–µ–≥—Ä–∞—Ü') || lowerMessage.includes('pos') || lowerMessage.includes('iiko')) {
    return `üîó Delever –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å:

‚Ä¢ POS: iiko, R-Keeper, Poster, Jowi
‚Ä¢ –ê–≥—Ä–µ–≥–∞—Ç–æ—Ä—ã: Wolt, Glovo, Uzum Tezkor
‚Ä¢ –û–ø–ª–∞—Ç–∞: Payme, Click, Uzum

–î–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π: +998 78 113 98 13`
  }
  
  if (lowerMessage.includes('–ø—Ä–∏–≤–µ—Ç') || lowerMessage.includes('–∑–¥—Ä–∞–≤—Å—Ç–≤') || lowerMessage.includes('–¥–æ–±—Ä')) {
    return `–ü—Ä–∏–≤–µ—Ç! üëã

–Ø –º–æ–≥—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ:
‚Ä¢ –¢–∞—Ä–∏—Ñ–∞—Ö –∏ —Ü–µ–Ω–∞—Ö
‚Ä¢ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è—Ö (iiko, R-Keeper, –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä—ã)
‚Ä¢ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã

–ß—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?`
  }
  
  return `–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–æ–ø—Ä–æ—Å! 

–î–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏:
üìû +998 78 113 98 13
üìß support@delever.uz

–ò–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ "—Ç–∞—Ä–∏—Ñ—ã", "–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏" –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.`
}

// –ò—Å–ø–æ–ª—å–∑—É–µ–º KNOWLEDGE_BASE —á—Ç–æ–±—ã TypeScript –Ω–µ —Ä—É–≥–∞–ª—Å—è
void KNOWLEDGE_BASE

export default async function handler(req: Request): Promise<Response> {
  // CORS headers
  const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'POST, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type',
  }

  if (req.method === 'OPTIONS') {
    return new Response(null, { status: 200, headers: corsHeaders })
  }

  if (req.method !== 'POST') {
    return new Response(JSON.stringify({ error: 'Method not allowed' }), {
      status: 405,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
    })
  }

  const openaiKey = process.env.OPENAI_API_KEY
  
  // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ ‚Äî –≤—Ä–µ–º–µ–Ω–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º info –æ –∫–ª—é—á–µ
  if (!openaiKey) {
    return new Response(JSON.stringify({ 
      error: 'OPENAI_API_KEY not found',
      debug: {
        hasKey: !!openaiKey,
        envKeys: Object.keys(process.env).filter(k => k.includes('OPENAI') || k.includes('AMO')).join(', ')
      }
    }), {
      status: 200,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
    })
  }
  
  console.log('Chatbot: Key found, prefix:', openaiKey.substring(0, 10))

  try {
    const body = await req.json()
    const { message, conversationHistory = [], source = 'website' } = body

    if (!message) {
      return new Response(JSON.stringify({ error: 'Message required' }), {
        status: 400,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      })
    }

    // –ü—Ä–æ—Å—Ç–æ–π –ø—Ä–æ–º–ø—Ç –¥–ª—è AI
    const simplePrompt = `–¢—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∫–æ–º–ø–∞–Ω–∏–∏ Delever. Delever ‚Äî —ç—Ç–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ –∏ –º–∞–≥–∞–∑–∏–Ω–æ–≤.

–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ Delever:
- –¢–∞—Ä–∏—Ñ—ã: Start (1.3 –º–ª–Ω —Å—É–º/–º–µ—Å), Medium (2.4 –º–ª–Ω), Big (4.3 –º–ª–Ω), Enterprise (6.5 –º–ª–Ω+)
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏: iiko, R-Keeper, Poster, Wolt, Glovo, Uzum Tezkor
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏: —Å–∞–π—Ç, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, Telegram-–±–æ—Ç, –∫—É—Ä—å–µ—Ä—Å–∫–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, CRM, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
- 1000+ –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ 7 —Å—Ç—Ä–∞–Ω–∞—Ö

–ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å –æ—Ç–≤–µ—Ç ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ —Å–≤—è–∑–∞—Ç—å—Å—è: +998 78 113 98 13`

    const chatMessages = [
      { role: 'system', content: simplePrompt },
      ...conversationHistory.slice(-6).map((m: {role: string, content: string}) => ({
        role: m.role,
        content: m.content
      })),
      { role: 'user', content: message }
    ]

    console.log('Chatbot: Calling OpenAI from USA region')
    
    const openaiResponse = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${openaiKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: chatMessages,
        temperature: 0.7,
        max_tokens: 300,
      })
    })

    console.log('Chatbot: OpenAI status:', openaiResponse.status)

    if (!openaiResponse.ok) {
      const errorText = await openaiResponse.text()
      console.error('OpenAI ERROR:', openaiResponse.status, errorText)
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ä–µ–≥–∏–æ–Ω–∞
      let isRegionBlocked = false
      try {
        const errorJson = JSON.parse(errorText)
        if (errorJson.error?.code === 'unsupported_country_region_territory' || 
            errorJson.error?.message?.includes('unsupported_country') ||
            errorJson.error?.message?.includes('region') ||
            errorJson.error?.message?.includes('territory')) {
          isRegionBlocked = true
        }
      } catch {
        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞–ø—Ä—è–º—É—é
        if (errorText.includes('unsupported_country') || 
            errorText.includes('region') || 
            errorText.includes('territory')) {
          isRegionBlocked = true
        }
      }
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º fallback –æ—Ç–≤–µ—Ç
      const fallbackMessage = getOfflineResponse(message)
      
      return new Response(JSON.stringify({
        success: true, // –í–æ–∑–≤—Ä–∞—â–∞–µ–º success: true, —á—Ç–æ–±—ã —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–∫–∞–∑–∞–ª —Å–æ–æ–±—â–µ–Ω–∏–µ
        message: fallbackMessage,
        fallback: true,
        intent: 'info',
        leadScore: 20,
        requestContact: false,
        source,
        ...(isRegionBlocked ? { 
          note: 'AI –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ –≤–∞—à–µ–º —Ä–µ–≥–∏–æ–Ω–µ, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∞–∑–æ–≤—ã–π –æ—Ç–≤–µ—Ç' 
        } : {
          debug: {
            status: openaiResponse.status,
            error: errorText.substring(0, 200)
          }
        })
      }), {
        status: 200,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      })
    }

    const aiData = await openaiResponse.json()
    const aiContent = aiData.choices?.[0]?.message?.content || ''
    
    console.log('Chatbot: AI response:', aiContent.substring(0, 100))

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
    const lowerMsg = message.toLowerCase()
    let leadScore = 20
    let requestContact = false
    
    if (lowerMsg.includes('—Ü–µ–Ω') || lowerMsg.includes('—Å—Ç–æ–∏') || lowerMsg.includes('—Ç–∞—Ä–∏—Ñ')) {
      leadScore = 50
    }
    if (lowerMsg.includes('–ø–æ–¥–∫–ª—é—á') || lowerMsg.includes('–¥–µ–º–æ') || lowerMsg.includes('—Ö–æ—á—É')) {
      leadScore = 70
      requestContact = true
    }
    if (lowerMsg.includes('–º–æ–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω') || lowerMsg.includes('–º–æ–π –º–∞–≥–∞–∑–∏–Ω') || lowerMsg.includes('—É –º–µ–Ω—è')) {
      leadScore = 60
    }

    return new Response(JSON.stringify({
      success: true,
      message: aiContent,
      intent: 'info',
      leadScore,
      requestContact,
      source
    }), {
      status: 200,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
    })

  } catch (error) {
    console.error('Chatbot error:', error)
    return new Response(JSON.stringify({ 
      error: 'Internal error',
      message: '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏: +998 78 113 98 13'
    }), {
      status: 500,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
    })
  }
}

